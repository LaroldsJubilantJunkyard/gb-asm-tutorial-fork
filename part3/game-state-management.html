<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Game State Management - GB ASM Tutorial</title>

        <!-- Custom HTML head -->
        <meta name="twitter:card" content="summary_large_image"/>
        <meta name="twitter:site:id" content="@gbdev0"/>
        <meta property="og:title" content="Game State Management - GB ASM Tutorial" />
        <meta property="og:image" content="https://gbdev.io/gb-asm-tutorial/assets/banner/1200x628.png" />
        <meta property="og:site_name" content="GB ASM Tutorial"/>

        <meta name="description" content="A complete guide to programming Game Boy games in assembly.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../css/custom.css">

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><a href="../index.html">Home</a></li><li class="chapter-item affix "><a href="../roadmap.html">Roadmap</a></li><li class="chapter-item affix "><a href="../help-feedback.html">Help</a></li><li class="chapter-item affix "><li class="part-title">Part Ⅰ — Hello World!</li><li class="chapter-item "><a href="../part1/setup.html"><strong aria-hidden="true">1.</strong> Setup</a></li><li class="chapter-item "><a href="../part1/hello_world.html"><strong aria-hidden="true">2.</strong> Hello World!</a></li><li class="chapter-item "><a href="../part1/toolchain.html"><strong aria-hidden="true">3.</strong> The toolchain</a></li><li class="chapter-item "><a href="../part1/bin_and_hex.html"><strong aria-hidden="true">4.</strong> Binary and hexadecimal</a></li><li class="chapter-item "><a href="../part1/registers.html"><strong aria-hidden="true">5.</strong> Registers</a></li><li class="chapter-item "><a href="../part1/assembly.html"><strong aria-hidden="true">6.</strong> Assembly basics</a></li><li class="chapter-item "><a href="../part1/memory.html"><strong aria-hidden="true">7.</strong> Memory</a></li><li class="chapter-item "><a href="../part1/header.html"><strong aria-hidden="true">8.</strong> The header</a></li><li class="chapter-item "><a href="../part1/operations.html"><strong aria-hidden="true">9.</strong> Operations & flags</a></li><li class="chapter-item "><a href="../part1/jumps.html"><strong aria-hidden="true">10.</strong> Jumps</a></li><li class="chapter-item "><a href="../part1/tracing.html"><strong aria-hidden="true">11.</strong> Tracing</a></li><li class="chapter-item "><div><strong aria-hidden="true">12.</strong> Graphics</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../part1/tiles.html"><strong aria-hidden="true">12.1.</strong> Tiles</a></li><li class="chapter-item "><a href="../part1/palettes.html"><strong aria-hidden="true">12.2.</strong> Palettes</a></li><li class="chapter-item "><a href="../part1/tilemap.html"><strong aria-hidden="true">12.3.</strong> Tilemap</a></li></ol></li><li class="chapter-item "><a href="../part1/wrapup.html"><strong aria-hidden="true">13.</strong> Wrapping up</a></li><li class="chapter-item affix "><li class="part-title">Part Ⅱ — Our first game</li><li class="chapter-item "><a href="../part2/getting-started.html"><strong aria-hidden="true">14.</strong> Getting started</a></li><li class="chapter-item "><a href="../part2/objects.html"><strong aria-hidden="true">15.</strong> Objects</a></li><li class="chapter-item "><a href="../part2/functions.html"><strong aria-hidden="true">16.</strong> Functions</a></li><li class="chapter-item "><a href="../part2/input.html"><strong aria-hidden="true">17.</strong> Input</a></li><li class="chapter-item "><a href="../part2/collision.html"><strong aria-hidden="true">18.</strong> Collision</a></li><li class="chapter-item "><a href="../part2/bricks.html"><strong aria-hidden="true">19.</strong> Bricks</a></li><li class="chapter-item "><a href="../part2/wip.html"><strong aria-hidden="true">20.</strong> Work in progress</a></li><li class="chapter-item affix "><li class="part-title">Part III — Our second game</li><li class="chapter-item "><a href="../part3/getting-started.html"><strong aria-hidden="true">21.</strong> Getting Started</a></li><li class="chapter-item "><a href="../part3/the-starter.html"><strong aria-hidden="true">22.</strong> Download the Starter</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../part3/project-structure.html"><strong aria-hidden="true">22.1.</strong> Project Structure</a></li><li class="chapter-item "><a href="../part3/dependent-libraries.html"><strong aria-hidden="true">22.2.</strong> Dependent Libraries</a></li><li class="chapter-item "><a href="../part3/sprites-backgrounds.html"><strong aria-hidden="true">22.3.</strong> Sprites & Backgrounds</a></li><li class="chapter-item "><a href="../part3/sporbs-metasprites.html"><strong aria-hidden="true">22.4.</strong> Metasprites</a></li><li class="chapter-item "><a href="../part3/drawing-text.html"><strong aria-hidden="true">22.5.</strong> Drawing Text</a></li><li class="chapter-item "><a href="../part3/utilities.html"><strong aria-hidden="true">22.6.</strong> Included Utilities</a></li><li class="chapter-item "><a href="../part3/compilation.html"><strong aria-hidden="true">22.7.</strong> Compilation</a></li></ol></li><li class="chapter-item expanded "><a href="../part3/game-state-management.html" class="active"><strong aria-hidden="true">23.</strong> Game State Management</a></li><li class="chapter-item "><a href="../part3/title-screen.html"><strong aria-hidden="true">24.</strong> Title Screen</a></li><li class="chapter-item "><a href="../part3/story-screen.html"><strong aria-hidden="true">25.</strong> Story Screen</a></li><li class="chapter-item "><a href="../part3/gameplay.html"><strong aria-hidden="true">26.</strong> Gameplay</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../part3/object-pools.html"><strong aria-hidden="true">26.1.</strong> Object Pools</a></li><li class="chapter-item "><a href="../part3/scrolling-background.html"><strong aria-hidden="true">26.2.</strong> Scrolling Background</a></li><li class="chapter-item "><a href="../part3/heads-up-interface.html"><strong aria-hidden="true">26.3.</strong> Heads-Up Interface</a></li><li class="chapter-item "><a href="../part3/the-player.html"><strong aria-hidden="true">26.4.</strong> The Player</a></li><li class="chapter-item "><a href="../part3/bullets.html"><strong aria-hidden="true">26.5.</strong> Bullets</a></li><li class="chapter-item "><a href="../part3/enemies.html"><strong aria-hidden="true">26.6.</strong> Enemies</a></li><li class="chapter-item "><a href="../part3/collision.html"><strong aria-hidden="true">26.7.</strong> Collision Detection</a></li><li class="chapter-item "><a href="../part3/collision.html"><strong aria-hidden="true">26.8.</strong> Enemy Collisions</a></li></ol></li><li class="chapter-item "><a href="../part3/conclusion.html"><strong aria-hidden="true">27.</strong> Conclusion</a></li><li class="chapter-item affix "><a href="../next.html">Where to go next</a></li><li class="chapter-item affix "><a href="../resources.html">Resources</a></li><li class="chapter-item affix "><a href="../thanks.html">Thanks</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">GB ASM Tutorial</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        <button id="language-toggle" class="icon-button" type="button"
                                title="Change language" aria-label="Change language"
                                aria-haspopup="true" aria-expanded="false"
                                aria-controls="language-list">
                            <i class="fa fa-globe"></i>
                        </button>
                        <ul id="language-list" class="theme-popup" aria-label="Languages" role="menu">
                          <li role="none"><button role="menuitem" class="theme">
                              <a id="en">English</a>
                          </button></li>
                          <li role="none"><button role="menuitem" class="theme">
                              <a id="it">Italian</a>
                          </button></li>
                        </ul>

                        <script>
                          let langToggle = document.getElementById("language-toggle");
                          let langList = document.getElementById("language-list");
                          langToggle.addEventListener("click", (event) => {
                              langList.style.display = langList.style.display == "block" ? "none" : "block";
                          });
                          let selectedLang = document.getElementById("en");
                          selectedLang.parentNode.classList.add("theme-selected");

                          // The path to the root, taking the current
                          // language into account.
                          let full_path_to_root = "../";
                          // The page path (mdbook only gives us
                          // access to the path to the Markdown file).
                          let path = "part3/game-state-management.md".replace(/\.md$/, ".html");
                          for (let lang of langList.querySelectorAll("a")) {
                              if (lang.id == "en") {
                                  lang.href = `${full_path_to_root}${path}`;
                              } else {
                                  lang.href = `${full_path_to_root}${lang.id}/${path}`;
                              }
                          }
                        </script>

                        
                        <a href="https://github.com/gbdev/gb-asm-tutorial" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/gbdev/gb-asm-tutorial/edit/master/src/part3/game-state-management.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="changing-game-states"><a class="header" href="#changing-game-states">Changing Game States</a></h1>
<p>In our <a href="https://github.com/gbdev/gb-asm-tutorial/blob/master/galactic-armada/src/main/GalacticArmada.asm">GalacticArmada.asm</a> file, we’ll define label called “NextGameState”. Our game will have 3 game states:</p>
<ul>
<li>Title Screen</li>
<li>Story Screen</li>
<li>Gameplay</li>
</ul>
<p>Here is how they will flow:</p>
<p><img src="../assets/part3/img/Game_States_Visualized.png" alt="Game States Visualized.png" /></p>
<p>This page will show you how to setup basic game state management. For organization, we’ll put our game state management code inside of a new file.</p>
<p><strong>Create “game-state-management.asm” right next to the entrypoint “GalacticArmada.asm”</strong></p>
<h2 id="setting-up-game-state-management"><a class="header" href="#setting-up-game-state-management">Setting up Game State Management</a></h2>
<p>First thing we’ll do in our new “game-state-management.asm” file is setup 3 variables in working ram. </p>
<ul>
<li><strong>wCurrentGameState_Update</strong> - the address of the current game state’s update function</li>
<li><strong>wNextGameState_Initiate</strong> - If we are changing game states, this will be non-zero. In that case, it will be the address of the “initiate” function for that game state.</li>
<li><strong>wNextGameState_Update</strong> - If we are changing game states, this will be non-zero. In that case, it will be the address of the “update” function for that game state. It will overwrite the <code>wCurrentGameState_Update</code> variable after the above <code>wNextGameState_Initiate</code> is called.</li>
</ul>
<p><strong>Create those 3 variables as “words” at the top of our game-state-management.asm file, in the working ram section titled “GameStateManagementVariables”:</strong></p>
<blockquote>
<p><strong>Note:</strong> See the RGBDS page on <a href="https://rgbds.gbdev.io/docs/v0.6.1/rgbasm.5#DEFINING_DATA">“Defining Data”</a> for more information about variable types.</p>
</blockquote>
<pre><code class="language-rgbasm  linenos start=2">INCLUDE &quot;src/main/includes/hardware.inc&quot;

SECTION &quot;GameStateManagementVariables&quot;, WRAM0

wCurrentGameState_Update:: dw
wNextGameState_Initiate:: dw
wNextGameState_Update:: dw
</code></pre>
<p><strong>Next, create a function called <code>InitializeGameStateManagement</code>.</strong> This function should go inside of a section called “GameStateManagement”, and be exported. See <a href="https://rgbds.gbdev.io/docs/v0.6.1/rgbasm.5#Labels">here</a> for more information about exporting.</p>
<p>In this function we’ll default all of our game state variables to 0.</p>
<pre><code class="language-rgbasm  linenos">
SECTION &quot;GameStateManagement&quot;, ROM0

InitializeGameStateManagment::
	
	; Default our game state variables
	ld a, 0
	ld [wCurrentGameState_Update+0], a
	ld [wCurrentGameState_Update+1], a
	ld [wNextGameState_Initiate+0], a
	ld [wNextGameState_Initiate+1], a
	ld [wNextGameState_Update+0], a
	ld [wNextGameState_Update+1], a

    ret
</code></pre>
<p>If we return back to our GalacticArmada.asm file, we’ll put in a call to our new <code>InitializeGameStateManagement</code> function. This function call will go right before our game loop:</p>
<pre><code class="language-rgbasm  linenos">    ; Inside of GalacticArmada.asm
	; ... Previous &quot;EntryPoint&quot; logic

	call InitializeGameStateManagment

GalacticArmadaGameLoop:
</code></pre>
<p>Now we have to setup and implement those variables. To do that, we’ll create the following functions: </p>
<ul>
<li><strong>InitiateNewGameStates</strong> - This will initialize the new game state, if we are changing game states.</li>
<li><strong>UpdateCurrentGameState</strong> - This will update the current game state, if it exists.</li>
</ul>
<h3 id="initiate-new-game-states"><a class="header" href="#initiate-new-game-states">Initiate New Game States</a></h3>
<p>We previously created a <code>wNextGameState_Initiate</code> variable. This variable will be used to hold an address. That address will point to the initiation logic for the next game state. If this variable is 0, then the game is NOT changing game states. If the variable is NOT 0, then we’ll call the function it specifies.</p>
<p>After we’ve called that initiate function, we’ll update our <code>wCurrentGameState_Update</code> variable. We’ll override it’s current value, with the value specified in our other variable: <code>wNextGameState_Update</code>. This will tell the game to start calling the new game state’s update logic instead of our curernt/old one.</p>
<p>With those changes done, we’ll reset our <code>wNextGameState_Initiate</code> and <code>wNextGameState_Update</code> variables back to 0. This will prevent the initiation logic from executing again until we change the game state.</p>
<p><strong>Create this function at the bottom of the game-state-management.asm file:</strong></p>
<pre><code class="language-rgbasm linenos start=52">InitiateNewCurrentGameState::

	; If this is 0, we are not changing game states
	ld a, [wNextGameState_Initiate+0]
	ld l, a
	ld a, [wNextGameState_Initiate+1]
	or a, l
	ret z

	ld a, [wNextGameState_Initiate+1]
	ld h, a	
	call callHL

	ld a, [wNextGameState_Update+0]
	ld [wCurrentGameState_Update+0], a
	ld a, [wNextGameState_Update+1]
	ld [wCurrentGameState_Update+1], a

	; Reset these to zero
	ld a, 0
	ld [wNextGameState_Initiate+0],a
	ld [wNextGameState_Initiate+1], a
	ld [wNextGameState_Update+0], a
	ld [wNextGameState_Update+1], a


	ret

</code></pre>
<blockquote>
<p><strong>Note:</strong> The <code>callHL</code> function will already be included in the starter. It simply provides an easy way to jump to dynamic addresses and return afterwards.</p>
</blockquote>
<h3 id="updating-the-current-game-state"><a class="header" href="#updating-the-current-game-state">Updating the current Game State</a></h3>
<p>For updating the current game state, we’ll get the address in our <code>wCurrentGameState_Update</code> variable. If it’s 0, we’ll return early. Otherwise, we’ll call the function located at that address and return when the function is done.</p>
<p><strong>Create this function at the bottom of the game-state-management.asm file:</strong></p>
<pre><code class="language-rgbasm linenos start=34">UpdateCurrentGameState::

	; Get the address of the current game state
	ld a, [wCurrentGameState_Update+0]
	ld l, a
	ld a, [wCurrentGameState_Update+1]
	or a, l

	; Stop if we have a 0 value
	ret z

	; call the function in HL
	ld a, [wCurrentGameState_Update+1]
	ld h, a
	call callHL

	ret
</code></pre>
<h2 id="adding-game-state-management-to-our-game-loop"><a class="header" href="#adding-game-state-management-to-our-game-loop">Adding Game State Management to our Game Loop</a></h2>
<p>Now that we have created our <code>InitiateNewCurrentGameState</code> and <code>UpdateCurrentGameState</code> functions, we can implement them</p>
<p><strong>Go back to our “GalacticArmada.asm” file. In the <code>GalacticArmadaGameLoop</code> function, (after we call <code>ResetShadowOAM</code>) add calls to those 2 functions</strong></p>
<pre><code class="language-rgbasm  linenos">; Inside of GalacticArmada.asm
GalacticArmadaGameLoop:

	; ... existing logic calling 'Input' and `ResetShadowOAM`

	call InitiateNewCurrentGameState
	call UpdateCurrentGameState

    ; ... existing logic waiting for VBlank start, before calling `hOAMDMA` and looping.
</code></pre>
<p>That wraps up game state management for now. We’ve got one more thing to do, setup a default game state. That task won’t be done yet. </p>
<p>In the next page, you’ll create the title screen. Once we’ve fully setup that game state, we’ll come back to the GalacticArmada.asm file and specify it as our default game state.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../part3/compilation.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../part3/title-screen.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../part3/compilation.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../part3/title-screen.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../js/linenos.js"></script>


    </body>
</html>
